<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f4f5;
    }

    h1 {
      margin-bottom: 12px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    input, select, button {
      padding: 8px 12px;
      font-size: 14px;
    }

    button {
      cursor: pointer;
    }

    .error {
      color: #b00020;
      margin-bottom: 12px;
    }

    .order {
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }

    .badge.buy { background: #e0f2fe; color: #0369a1; }
    .badge.sell { background: #fef3c7; color: #92400e; }

    .status {
      font-size: 12px;
      font-weight: 700;
      color: #555;
    }

    ul {
      padding-left: 18px;
    }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .approve {
      background: #15803d;
      color: #fff;
      border: none;
      border-radius: 6px;
    }

    .approve:hover {
      background: #166534;
    }
  </style>
</head>
<body>

  <h1>Admin – Orders</h1>

  <div class="toolbar">
    <input id="tokenInput" type="password" placeholder="Admin token" />
    <select id="typeFilter">
      <option value="">All types</option>
      <option value="buy">Buy</option>
      <option value="sell">Sell</option>
    </select>
    <select id="statusFilter">
      <option value="">All statuses</option>
      <option value="submitted">submitted</option>
      <option value="paid">paid</option>
      <option value="checked_in">checked_in</option>
      <option value="approved">approved</option>
      <option value="fulfilled">fulfilled</option>
      <option value="needs_review">needs_review</option>
    </select>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div id="error" class="error"></div>
  <div id="orders"></div>

  <script>
    const ordersEl = document.getElementById("orders");
    const errorEl = document.getElementById("error");
    const tokenInput = document.getElementById("tokenInput");
    const typeFilter = document.getElementById("typeFilter");
    const statusFilter = document.getElementById("statusFilter");

    document.getElementById("refreshBtn").addEventListener("click", loadOrders);

    async function apiFetch(url, options = {}) {
      const token = tokenInput.value.trim();
      const headers = options.headers || {};
      headers["x-admin-token"] = token;
      options.headers = headers;

      const res = await fetch(url, options);
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} ${text}`);
      }
      return res.json();
    }

    async function loadOrders() {
      errorEl.textContent = "";
      ordersEl.innerHTML = "";

      try {
        const data = await apiFetch("/api/admin/orders");
        let orders = data.orders || [];

        if (typeFilter.value) {
          orders = orders.filter(o => o.type === typeFilter.value);
        }

        if (statusFilter.value) {
          orders = orders.filter(o => o.status === statusFilter.value);
        }

        for (const o of orders) {
          renderOrder(o);
        }

        if (!orders.length) {
          ordersEl.textContent = "No orders found.";
        }
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    function renderOrder(order) {
      const div = document.createElement("div");
      div.className = "order";

      div.innerHTML = `
        <div class="order-header">
          <div>
            <strong>${order.id}</strong>
            <span class="badge ${order.type}">${order.type.toUpperCase()}</span>
          </div>
          <div class="status">${order.status}</div>
        </div>

        <div>
          <div><strong>Email:</strong> ${order.customer?.email || ""}</div>
          <div><strong>Total:</strong> $${(order.totalCents / 100).toFixed(2)}</div>
        </div>

        <ul>
          ${(order.lines || []).map(l =>
            `<li>${l.qty} × ${l.sku} (${l.condition})</li>`
          ).join("")}
        </ul>

        <div class="actions">
          ${
            order.status === "submitted" || order.status === "paid"
              ? `<button class="approve" onclick="approveOrder('${order.id}')">
                   Mark received (add to stock)
                 </button>`
              : ""
          }
        </div>
      `;

      ordersEl.appendChild(div);
    }

    async function approveOrder(id) {
      errorEl.textContent = "";
      try {
        await apiFetch(`/api/admin/orders/${encodeURIComponent(id)}/approve`, {
          method: "POST"
        });
        loadOrders();
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    // Auto-load if token is in URL
    const params = new URLSearchParams(location.search);
    if (params.get("token")) {
      tokenInput.value = params.get("token");
      loadOrders();
    }
  </script>
</body>
</html>

