<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My Account</title>
  <link rel="stylesheet" href="/style.css"/>

  <style>
    .card { background: rgba(255,255,255,.95); padding:16px; border-radius:12px; margin:12px 0; }
    .row { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .muted { opacity:.8; }
    .btn { padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.15); background:#fff; cursor:pointer; font-weight:700; }
    .btn:hover { filter: brightness(0.98); }
    .field { display:flex; flex-direction:column; gap:6px; margin: 10px 0; }
    .field label { font-weight:700; font-size:13px; }
    .field input { padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.18); }
  </style>
</head>

<body>
  <div class="page-wrap">
    <div class="row" style="align-items:center;">
      <h1>My Account</h1>
      <button id="logout" class="btn" type="button">Logout</button>
    </div>

    <div id="who" class="card">Loading…</div>

    <!-- ✅ NEW: Address card -->
    <div id="address" class="card">Loading address…</div>

    <div id="orders" class="card">Loading orders…</div>

    <p><a href="/">Back to shop</a></p>
  </div>

  <script>
    async function load() {
      const meRes = await fetch("/api/me", { cache: "no-store" });
      const me = await meRes.json().catch(()=>({}));
      if (!me.ok || !me.user) {
        window.location.href = "/login.html";
        return;
      }

      document.getElementById("who").innerHTML =
        `<strong>${me.user.name || "Customer"}</strong><div class="muted">${me.user.email}</div>`;

      // ---- Address UI ----
      const addrEl = document.getElementById("address");
      const a = me.user.address || null;

      function esc(s){
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;");
      }

      function renderAddress(viewMode = true, addr = a) {
        if (!addrEl) return;

        if (viewMode) {
          if (!addr || !addr.line1) {
            addrEl.innerHTML = `
              <div class="row" style="align-items:flex-start;">
                <div>
                  <strong>Shipping Address</strong>
                  <div class="muted" style="margin-top:6px;">No address on file.</div>
                </div>
                <button id="editAddr" class="btn" type="button">Add</button>
              </div>
            `;
            document.getElementById("editAddr").onclick = () => renderAddress(false, {
              line1:"", line2:"", city:"", state:"", postal:"", country:"US"
            });
            return;
          }

          const line2 = addr.line2 ? `<div>${esc(addr.line2)}</div>` : "";
          addrEl.innerHTML = `
            <div class="row" style="align-items:flex-start;">
              <div>
                <strong>Shipping Address</strong>
                <div style="margin-top:8px;">
                  <div>${esc(addr.line1)}</div>
                  ${line2}
                  <div>${esc(addr.city)}, ${esc(addr.state)} ${esc(addr.postal)}</div>
                  <div class="muted">${esc(addr.country || "US")}</div>
                </div>
              </div>
              <button id="editAddr" class="btn" type="button">Edit</button>
            </div>
            <div id="addrMsg" class="muted" style="margin-top:10px;"></div>
          `;

          document.getElementById("editAddr").onclick = () => renderAddress(false, addr);
          return;
        }

        // edit mode
        addrEl.innerHTML = `
          <strong>Shipping Address</strong>
          <div class="muted" style="margin-top:6px;">Used for buy orders shipping.</div>

          <div class="field" style="margin-top:12px;">
            <label for="line1">Street address</label>
            <input id="line1" autocomplete="address-line1" value="${esc(addr?.line1)}" />
          </div>

          <div class="field">
            <label for="line2">Apartment / Suite (optional)</label>
            <input id="line2" autocomplete="address-line2" value="${esc(addr?.line2)}" />
          </div>

          <div class="field">
            <label for="city">City</label>
            <input id="city" autocomplete="address-level2" value="${esc(addr?.city)}" />
          </div>

          <div class="row" style="gap:12px; align-items:flex-end;">
            <div class="field" style="flex:1;">
              <label for="state">State</label>
              <input id="state" autocomplete="address-level1" value="${esc(addr?.state)}" />
            </div>

            <div class="field" style="flex:1;">
              <label for="postal">ZIP Code</label>
              <input id="postal" autocomplete="postal-code" value="${esc(addr?.postal)}" />
            </div>
          </div>

          <div class="row" style="margin-top:12px; align-items:center;">
            <button id="saveAddr" class="btn" type="button">Save</button>
            <button id="cancelAddr" class="btn" type="button">Cancel</button>
            <div id="addrMsg" class="muted" style="margin-left:auto;"></div>
          </div>
        `;

        document.getElementById("cancelAddr").onclick = () => renderAddress(true, a);

        document.getElementById("saveAddr").onclick = async () => {
          const next = {
            line1: String(document.getElementById("line1").value || "").trim(),
            line2: String(document.getElementById("line2").value || "").trim(),
            city:  String(document.getElementById("city").value  || "").trim(),
            state: String(document.getElementById("state").value || "").trim(),
            postal:String(document.getElementById("postal").value|| "").trim(),
            country: "US"
          };

          const msg = document.getElementById("addrMsg");
          if (!next.line1 || !next.city || !next.state || !next.postal) {
            msg.textContent = "Please fill out line1, city, state, and ZIP.";
            return;
          }

          msg.textContent = "Saving…";

          const res = await fetch("/api/me/address", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address: next })
          });

          const data = await res.json().catch(()=>({}));
          if (!res.ok || !data.ok) {
            msg.textContent = data.error || "Could not save address.";
            return;
          }

          // update local copy and re-render
          me.user.address = data.address;
          renderAddress(true, data.address);
        };
      }

      renderAddress(true, a);

      // ---- Orders ----
      const oRes = await fetch("/api/my/orders", { cache: "no-store" });
      const oData = await oRes.json().catch(()=>({}));
      if (!oRes.ok || !oData.ok) {
        document.getElementById("orders").textContent = "Could not load orders.";
        return;
      }

      const orders = oData.orders || [];
      if (!orders.length) {
        document.getElementById("orders").innerHTML =
          "<strong>Orders</strong><p class='muted'>No orders yet.</p>";
        return;
      }

      document.getElementById("orders").innerHTML =
        `<strong>Orders</strong>` +
        orders.map(o => `
          <div style="margin-top:10px; padding-top:10px; border-top:1px solid #ddd">
            <div class="row">
              <div><strong>${o.id}</strong> <span class="muted">(${o.type} • ${o.status})</span></div>
              <div><strong>$${((o.totalCents||0)/100).toFixed(2)}</strong></div>
            </div>
            <div class="muted">${new Date(o.createdAt).toLocaleString()}</div>
          </div>
        `).join("");
    }

    document.getElementById("logout").onclick = async () => {
      await fetch("/api/auth/logout", { method:"POST" });
      window.location.href = "/";
    };

    load();
  </script>
</body>
</html>
